---
title: "DoubletFinder"
author: "Nathan Ewing-Crystal"
date: "2023-05-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
***
Doubletfinder on 3_7dpi_Ctrl sample to investigate sobj.sub.fib cluster 6
https://github.com/chris-mcginnis-ucsf/DoubletFinder

Note - not using multiplexing, assuming "no ground truth"
Only on 3_7dpi_Ctrl for now - not supposed to run on samples from combined lanes
Using entire (not-subsetted) sobject --> include macrophage clusters in "fake" doublets


Note - performed on sobject.sub.fib with resolution = 0.25 (fewer clusters), did not rerun on new cluster set
***
```{r}
library(Seurat)
library(ggplot2)

#remotes::install_github('chris-mcginnis-ucsf/DoubletFinder')
library("DoubletFinder")
```

```{r}
#Specify your preferred directory for all input + output
dir = "/Users/nathanewing-crystal/Dropbox (Ari Molofsky Lab)/Ari Molofsky Lab Team Folder/Nathan Ewing-Crystal/RNASeq/Lesion snRNASeq/seurat"
#Specify exactly where your seurat files live
datafolder = "Data/Seurat"

project<-"lesion_snRNASeq" 

Plotfolder = "Plots/Fibroblast Subset"
iterationname = "fib_reclustered"

#load sobj.sub.fib
load(file.choose())
```

```{r}
i = 2
#1 for 7dpi, 2 for 21dpi
#Note - ONLY USE 1 LANE

samples_to_test = c("3_7dpi_Ctrl", "4_21dpi_Ctrl")
sample_to_test = samples_to_test[i]

sobj_doublets = subset(sobject, cells = which(sobject$sample == sample_to_test))
DefaultAssay(sobj_doublets) = "SCT"

#below code from DoubletFinder README example code

## pK Identification (no ground-truth)
sweep.res.list <- paramSweep_v3(sobj_doublets, PCs = 1:30, sct = TRUE)
sweep.stats <- summarizeSweep(sweep.res.list, GT = FALSE)
bcmvn <- find.pK(sweep.stats)

#select max
bcmvn$pK[which.max(bcmvn$BCmetric)]
pks = c(0.12, 0.3)
pk = pks[i] #manual selection
#pk = 0.12 for 3_7dpi_ctrl
#pk = 0.3 for 4_21dpi_ctrl

## Homotypic Doublet Proportion Estimate
homotypic.prop <- modelHomotypic(sobj_doublets$celltype)

percents_multi = c(0.024, 0.04)
percent_multi = percents_multi[i]
# Assuming 2.4% doublet rate for 3_7dpi_ctrl
# Assuming 4.0% doublet rate for 4_21dpi_ctrl
# [based on 10x multiplet formation guide]
nExp_poi <- round(percent_multi*nrow(sobj_doublets@meta.data))  

nExp_poi.adj <- round(nExp_poi*(1-homotypic.prop))

## Run DoubletFinder 
sobj_doublets <- doubletFinder_v3(sobj_doublets, PCs = 1:30, pN = 0.25, pK = pk, nExp = nExp_poi.adj, reuse.pANN = FALSE, sct = TRUE)

dfs = c("DF.classifications_0.25_0.28_76", "DF.classifications_0.25_0.3_305")
df = dfs[i]
DimPlot(sobj_doublets, group.by = "celltype", split.by = df, label = T)
DimPlot(sobj_doublets, group.by = df)
```

